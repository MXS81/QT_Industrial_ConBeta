# 多功能磁浮作业配置系统 (MaglevControl)

## 项目概述

多功能磁浮作业配置系统是一个基于Qt框架开发的工业控制上位机软件，专门用于磁浮系统的控制和监控。系统采用模块化架构设计，通过Modbus TCP协议与工业控制器通信，提供单轴控制、多轴管理和工业配方管理等功能。

### 主要特性

- ✅ **模块化架构** - 基于BaseController的可扩展模块设计
- ✅ **Modbus TCP通信** - 稳定的工业级通信协议，支持10秒心跳和掩码写
- ✅ **多控制模式** - 支持单轴精确控制和多轴批量管理
- ✅ **配方管理系统** - 完整的工位配方管理和标准化Modbus写入
- ✅ **实时监控** - 连接状态监控、操作日志和错误处理
- ✅ **工业化UI** - 选项卡式界面和专业的工业风格设计
- ✅ **数据处理** - 32位数据高低字处理和8位参数打包优化
- ✅ **异常处理** - 分层错误处理和详细的日志记录系统

## 系统要求

### 硬件要求
- CPU: Intel i3 或同等性能处理器
- 内存: 至少 2GB RAM
- 存储: 100MB 可用磁盘空间
- 网络: 以太网接口（用于Modbus TCP通信）

### 软件要求
- 操作系统: Windows 7/8/10/11 (64位)
- Qt运行库: Qt 5.12 或更高版本
- Visual C++ 可再发行组件包 (2017+)
- .NET Framework 4.5+ (部分功能需要)

## 安装指南

### 方式一：二进制安装（推荐）

1. 下载最新版本的安装包
2. 运行安装程序并按照向导完成安装
3. 确保安装了必要的运行库

### 方式二：源码编译

#### 环境准备

1. **安装Qt开发环境**
   ```bash
   # 下载并安装Qt Creator和Qt库（版本5.12+）
   # 确保包含以下模块：
   # - Qt Core
   # - Qt GUI
   # - Qt Widgets
   # - Qt SerialBus
   ```

2. **配置编译器**
   - Windows: Visual Studio 2017/2019/2022 或 MinGW
   - 确保编译器支持C++11标准

#### 编译步骤

1. **克隆或下载源码**
   ```bash
   git clone <repository-url>
   cd MaglevControl
   ```

2. **使用Qt Creator编译**
   - 打开 `MaglevControl.pro`
   - 配置构建套件
   - 选择Release模式以获得最佳性能
   - 点击构建按钮

3. **使用命令行编译**
   ```bash
   # Windows (MSVC) - Release版本
   qmake MaglevControl.pro -config release
   nmake
   
   # Windows (MinGW)
   qmake MaglevControl.pro -config release
   mingw32-make
   ```

## 使用指南

### 快速开始

1. **启动应用程序**
   - 双击桌面图标或从开始菜单启动
   - 程序将显示主界面

2. **配置连接**
   - 在"Modbus TCP 连接设置"区域输入控制器IP地址（默认：192.168.5.5）
   - 设置通信端口（默认：502，标准Modbus TCP端口）
   - 点击"连接"按钮，系统将自动启动10秒心跳维护连接

3. **选择控制模式**
   - **单轴控制**：精确控制单个电机轴，支持手动点动和自动运行
   - **多轴控制**：批量管理多个电机轴，支持统一参数设置
   - **配方管理**：工位配方参数配置和标准化Modbus写入

### 详细操作指南

#### 单轴控制

1. **基本设置**
   ```
   1. 轴使能 → 点击"使能"按钮激活电机轴（使用掩码写避免位冲突）
   2. 控制权限 → 勾选"允许手动控制"（可选）
   3. 运行模式 → 选择"点动模式"或"自动模式"
   ```

2. **点动模式操作**
   - 设置Jog速度（10000-100000 rpm，32位数据自动拆分高低字）
   - 设置Jog位置（-1000 到 1000 mm）
   - 使用"<"和">"按钮进行精确移动
   - 系统自动处理32位速度数据的高低16位寄存器写入

3. **自动模式操作**
   - 设置自动速度（10000-100000 rpm）
   - 点击"运行"开始自动运行
   - 点击"停止"结束运行
   - 所有控制位使用原子性掩码写操作

#### 多轴控制

1. **轴管理**
   - 点击"添加轴"增加新的控制轴（最多支持16轴）
   - 点击"移除轴"删除最后一个轴
   - 使用表格管理各轴的参数和状态

2. **批量操作**
   - "全部使能"/"全部禁用"：批量控制所有轴的使能状态
   - "统一速度设置"：为所有轴应用相同速度参数
   - 支持单轴独立控制和批量同步操作

#### 配方管理

1. **工位配方编辑**
   - 支持最多10个工位的完整配方参数配置
   - 每个工位包含：工位号、任务ID、路段参数、位置设置、延时配置等
   - 实时参数验证和范围检查

2. **配方保存和加载**
   - 支持完整配方的JSON格式保存和加载
   - 配方重命名、删除和批量操作
   - 一键应用配方到设备

3. **标准化Modbus写入**
   - 按照8寄存器工位布局标准化写入
   - 从保持寄存器[36]开始的连续写入
   - 8位参数自动打包到16位寄存器
   - 支持工位总数和配方数据的完整同步

### 界面说明

#### 主界面布局

```
┌─────────────────────────────────────────┐
│  Modbus TCP 连接设置 (10秒心跳)         │
├─────────────────────────────────────────┤
│ ┌─单轴控制──┐ ┌─多轴控制──┐ ┌─配方管理─┐│
│ │[选项卡1]  │ │[选项卡2]  │ │[选项卡3] ││
│ │ 使能设置  │ │ 轴管理    │ │ 工位配方 ││
│ │ 模式选择  │ │ 参数配置  │ │ 参数编辑 ││
│ │ 速度调节  │ │ 批量操作  │ │ 配方保存 ││
│ │ 点动控制  │ │ 状态监控  │ │ 设备同步 ││
│ └───────────┘ └───────────┘ └─────────┘│
├─────────────────────────────────────────┤
│  实时操作日志 (LogManager)              │
│  [时间戳] 连接状态、操作记录、错误信息   │
└─────────────────────────────────────────┘
```

#### 状态指示

- 🔴 **红色按钮**：未使能状态
- 🟢 **绿色按钮**：已使能状态  
- 🟡 **黄色文字**：正在连接
- 🔴 **红色文字**：连接失败/未连接
- 🟢 **绿色文字**：连接成功

## 配置说明

### 通信参数

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| IP地址 | 192.168.5.5 | - | PLC控制器IP地址 |
| 端口 | 502 | 1-65535 | Modbus TCP标准端口 |
| 从站地址 | 1 | 1-255 | Modbus设备地址 |
| 心跳间隔 | 10秒 | 5-60秒 | 防止自动断连的心跳间隔 |

### 控制参数

| 参数 | 范围 | 单位 | 说明 |
|------|------|------|------|
| 速度设置 | 10000-100000 | rpm | 电机转速 |
| 位置设置 | -1000 到 1000 | mm | 移动距离 |

### 寄存器映射

#### 单轴控制寄存器
| 地址 | 功能 | 位定义/格式 |
|------|------|-------------|
| 0x0000 | 控制寄存器 | bit0:使能, bit1:模式, bit2:手动权限, bit3:JogLeft, bit4:JogRight, bit5:自动运行 |
| 0x0001-0x0002 | 自动速度 | 32位速度值（低16位+高16位） |
| 0x0003 | Jog位置 | 16位位置值 |
| 0x0004-0x0005 | Jog速度 | 32位速度值（低16位+高16位） |

#### 多轴控制寄存器
| 地址 | 功能 | 说明 |
|------|------|------|
| 0x0100+ | 多轴使能 | 各轴使能状态 |
| 0x0200+ | 多轴速度 | 各轴速度设置 |

#### 配方管理寄存器
| 地址 | 功能 | 格式说明 |
|------|------|----------|
| 0x0023 | 工位总数 | 寄存器[35]，16位整数 |
| 0x0024+ | 配方数据 | 从寄存器[36]开始，每工位8个寄存器 |

**工位配方8寄存器布局**：
- 偏移0: 工位号(低8位) + 任务ID(高8位)
- 偏移1: 路段号(低8位) + 目标工位号(高8位)
- 偏移2-6: 路段位置、路段速度、起始位置、终止位置、到位延时
- 偏移7: 摆渡位置(低8位) + 工位屏蔽(高8位)

## 故障排除

### 常见问题

#### 1. 无法连接设备
**现象**：点击连接后显示"连接失败"
**解决方案**：
- 检查网络连接是否正常
- 确认IP地址和端口设置正确
- 验证防火墙设置
- 检查控制器是否正常运行

#### 2. 控制无响应
**现象**：发送控制命令后设备无反应
**解决方案**：
- 确认设备已使能
- 检查Modbus寄存器映射
- 验证参数范围是否合法
- 查看操作日志中的错误信息

#### 3. 界面异常
**现象**：界面显示不正常或崩溃
**解决方案**：
- 重启应用程序
- 检查Qt运行库版本
- 更新显卡驱动
- 检查系统兼容性

### 日志分析

程序运行时会在界面底部显示详细的操作日志：
```
[2024-01-15 14:30:25] 程序启动成功
[2024-01-15 14:30:30] 已连接到设备
[2024-01-15 14:30:35] 单动子已使能
[2024-01-15 14:30:40] 自动模式速度设置为 80000 rpm
```

## 开发指南

### 项目结构

```
MaglevControl/
├── main.cpp                    # 程序入口
├── mainwindow.h/.cpp           # 主窗口类(GUI控制器)
├── modbusmanager.h/.cpp        # Modbus通信管理器
├── basecontroller.h/.cpp       # 控制器基类
├── singleaxiscontroller.h/.cpp # 单轴控制器
├── multiaxiscontroller.h/.cpp  # 多轴控制器
├── recipemanager.h/.cpp        # 配方管理器
├── recipewidget.h/.cpp         # 配方界面组件
├── logmanager.h/.cpp           # 日志管理器
├── stylemanager.h/.cpp         # UI样式管理器
├── MaglevControl.pro           # Qt项目文件
├── Resource/                   # 资源文件
│   ├── Icon.qrc               # 资源配置
│   ├── mcs.png               # 应用图标
│   └── style.qss             # 样式表
├── build/                      # 构建输出
└── README/                     # 文档目录
    ├── README.md              # 项目说明
    ├── PROJECT_GUIDE.md       # 开发指南
    ├── PLC对接技术说明.md      # PLC对接文档
    ├── 代码说明文档.md         # 代码结构说明
    └── test.md               # 配方管理重构说明
```

### 核心类说明

#### MainWindow类 - GUI控制器
主窗口类，继承自QMainWindow，负责：
- 模块化UI界面管理（选项卡式）
- 模块间信号槽协调
- 用户交互处理和事件分发
- 整体应用生命周期管理

#### ModbusManager类 - 通信管理器
```cpp
class ModbusManager : public QObject {
public:
    static constexpr int kHeartbeatIntervalMs = 10000; // 10秒心跳
    
    bool connectToDevice(const QString& ip, int port);
    bool writeRegisterSync(int address, quint16 value, int timeoutMs = 5000);
    bool readRegisterSync(int address, quint16& value, int timeoutMs = 5000);
    bool maskWriteRegisterSync(int address, quint16 andMask, quint16 orMask, int timeoutMs = 5000);
};
```

#### BaseController类 - 控制器基类
```cpp
class BaseController : public QObject {
protected:
    bool checkConnection();
    void emitError(const QString& baseMessage, const QString& detail = "");
    ModbusManager* m_modbusManager;
};
```

#### RecipeManager类 - 配方管理器
```cpp
struct StationRecipe {
    quint8 stationNo, taskId, segmentNo, nextStationId;
    quint16 segmentPosition, segmentSpeed, startPosition, endPosition, arrivalDelay;
    FerryPosition ferryPos;
    bool stationMask;
};

class RecipeManager : public BaseController {
public:
    bool saveAllRecipes();  // 标准化8寄存器写入
    bool loadCompleteRecipe(const QString& recipeName);
    bool applyCompleteRecipeToDevice(const QString& recipeName);
};
```

### 扩展开发

#### 添加新控制器模块
1. 继承BaseController创建新的控制器类
2. 在MainWindow::initModules()中初始化
3. 在MainWindow::connectSignals()中建立信号连接
4. 添加对应的UI组件和布局
5. 更新.pro文件包含新的源码文件

#### 扩展配方管理功能
1. 在RecipeManager中定义新的寄存器地址常量
2. 扩展StationRecipe结构体添加新参数
3. 更新RecipeWidget界面支持新参数输入
4. 修改数据打包/解包方法
5. 更新PLC对接文档说明新的寄存器映射

#### 优化通信协议
1. 扩展ModbusManager支持新的功能码
2. 实现批量读写操作
3. 增强错误处理和重试机制
4. 优化心跳和连接管理逻辑

#### 自定义界面样式
1. 通过StyleManager管理全局样式
2. 编辑Resource/style.qss文件
3. 扩展StyleManager类支持更多主题

## 版本历史

### v1.2.0 (当前版本)
- 新增完整的配方管理系统（RecipeManager + RecipeWidget）
- 实现8寄存器工位配方标准化Modbus写入
- 优化心跳机制为10秒间隔，增加掩码写操作支持
- 重构为模块化架构，添加BaseController基类
- 完善32位数据高低字处理和8位参数打包
- 增强错误处理和日志记录系统
- 支持最多10工位和16轴的工业级控制

### v1.1.0
- 重构模块化架构设计
- 添加StyleManager和LogManager
- 优化Modbus通信稳定性
- 改进工业化UI设计

### v1.0.0
- 首次发布
- 实现基本的单轴和多轴控制功能
- 支持Modbus TCP通信
- 提供工业风格用户界面

## 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 支持与反馈

如果您在使用过程中遇到问题或有改进建议，请通过以下方式联系：

- 📧 邮箱：[your-email@example.com]
- 🐛 问题报告：[GitHub Issues]
- 📖 技术文档：[Wiki页面]

## 贡献指南

欢迎提交Pull Request来改进项目：

1. Fork本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建Pull Request

---

## 附录

### A. 项目开发指南

详细的开发指南包含以下内容：

#### A.1 开发环境搭建
- Qt开发环境安装和配置
- 编译器配置（MSVC/MinGW）
- 项目导入和构建配置

#### A.2 核心技术解析
- Modbus TCP通信实现
- 数据结构设计
- UI界面架构
- 工业风格样式实现

#### A.3 开发流程指南
- 新功能开发流程
- 参数配置扩展方法
- 调试技巧和性能优化

#### A.4 部署发布
- 构建配置和依赖库收集
- 安装包制作（NSIS/Inno Setup）
- 版本管理策略

### B. 配方管理系统重构说明

配方管理模块经过重构以实现标准化Modbus通信：

#### B.1 数据结构重构
- StationRecipe结构体更新
- 浮点数改为16位整数
- 添加目标工位号参数

#### B.2 Modbus寄存器映射
- 从保持寄存器[36]开始的标准化写入
- 每工位占用8个寄存器（优化存储效率）
- 数据打包/解包方法

#### B.3 用户界面优化
- 控件类型从浮点数改为整数
- 界面布局优化
- 当前工位显示移除

#### B.4 重构效果
- 存储效率提升47%（每工位从15个寄存器减少到8个）
- 数据传输可靠性提高（整数替代浮点数）
- 支持完整的工位流转逻辑（添加目标工位号参数）
- 实现标准化Modbus写入（从寄存器36开始的连续写入）
- 优化数据打包（8位参数打包到16位寄存器）

#### B.5 技术优势
- **高效通信**: 10秒心跳机制和掩码写操作避免自动断连
- **模块化设计**: BaseController基类架构支持功能扩展
- **数据完整性**: 32位数据自动拆分和8位参数智能打包
- **工业级可靠性**: 分层错误处理和详细操作日志
- **标准化接口**: 完全符合PLC对接技术规范

---

**感谢您使用多功能磁浮作业配置系统！**

---

## 相关文档链接

- 📖 **[开发指南](PROJECT_GUIDE.md)** - 详细的开发流程和技术架构
- 🔧 **[PLC对接技术说明](PLC对接技术说明.md)** - Modbus通信协议和寄存器映射
- 📝 **[代码说明文档](代码说明文档.md)** - 完整的代码结构和模块说明
- 🔄 **[配方管理重构说明](test.md)** - 配方系统重构的详细技术说明

## 技术支持

如需技术支持或报告问题，请查阅上述技术文档或联系项目维护团队。
